<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CONSULTAS - Coca-Cola</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div id="login-container">
    <form id="login-form">
      <h2>Iniciar Sesi√≥n</h2>
      <select id="store" name="store" required>
        <option value="" disabled selected>Selecciona tu supermercado</option>
      </select>
      <input type="text" id="username" name="username" placeholder="Usuario (email)" autocomplete="username" required>
      <input type="password" id="password" name="password" placeholder="Contrase√±a" autocomplete="current-password" required>
      <button type="submit">Entrar</button>
      <a href="admin.html" style="display: block; margin-top: 15px; text-align: center; color: var(--color-primary); font-size: 0.9rem; text-decoration: none; font-weight: 600;">‚öôÔ∏è Panel de Administraci√≥n</a>
    </form>
  </div>

  <div id="contenido" class="hidden">
    <header>
      <h1>CONSULTAS</h1>
      <button id="logout-btn" class="btn-logout" aria-label="Cerrar sesi√≥n">üö™ Cerrar Sesi√≥n</button>
    </header>
    <main>
      <div class="dropdown-container"><div id="filter-container"></div></div>
      <section id="product-list" aria-live="polite"></section>
      <div id="total-display" aria-live="polite">Total: ‚Ç¨0.00</div>
      <button id="cart-toggle" aria-label="Ver carrito">üõí</button>
      <div id="cart-modal" role="dialog" aria-modal="true" aria-labelledby="cart-modal-title">
        <div id="cart-modal-content">
          <h2 id="cart-modal-title">Tu Pedido</h2>
          <button id="close-modal" aria-label="Cerrar carrito">‚úñ</button>
          <div id="cart-items-modal">No hay productos a√±adidos.</div>
          <div id="modal-total">Total: ‚Ç¨0.00</div>
          <button id="submit-order">Enviar Pedido</button>
        </div>
      </div>
    </main>
  </div>

  <div id="fullscreen-modal" class="fullscreen-modal-overlay hidden">
    <span class="close-fullscreen-modal">&times;</span>
    <div class="fullscreen-modal-content"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA3SNRVPID2Gz85UhESHr_OEdxsL1PNodM",
      authDomain: "cocacolaconsultas-20759.firebaseapp.com",
      projectId: "cocacolaconsultas-20759",
      storageBucket: "cocacolaconsultas-20759.firebasestorage.app",
      messagingSenderId: "274074684363",
      appId: "1:274074684363:web:b988c76c7e74f9e1e3444e",
      measurementId: "G-29GJZ22GMM"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loginContainer = document.getElementById("login-container");
    const contenidoDiv = document.getElementById("contenido");
    const loginForm = document.getElementById("login-form");
    const storeSelect = document.getElementById("store");
    const headerH1 = document.querySelector("#contenido header h1");
    const logoutBtn = document.getElementById("logout-btn");

    function mostrarContenido(storeName) {
      loginContainer.style.display = "none";
      contenidoDiv.classList.remove("hidden");
      if (storeName && !headerH1.textContent.includes(storeName)) {
        headerH1.textContent += ` - ${storeName}`;
      }
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        const userStore = localStorage.getItem("userStore");
        mostrarContenido(userStore);
        localStorage.setItem("loggedInUser", user.email);
        loadImagesFromStorageBatched();
      } else {
        loginContainer.style.display = "flex";
        contenidoDiv.classList.add("hidden");
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const stores = ["CAT21","CAT22","CAT23","CAT24","CAT25","EJE4",
                      "Alcampo Sant Quirze","Carrefour Sant Cugat","Carrefour Barbera"];
      stores.forEach(s => {
        const opt = document.createElement("option");
        opt.value = opt.textContent = s;
        storeSelect.appendChild(opt);
      });
    });

    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      const store = storeSelect.value;
      const email = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!store) { alert("Por favor selecciona un supermercado."); return; }
      signInWithEmailAndPassword(auth, email, password)
        .then(() => { localStorage.setItem("userStore", store); mostrarContenido(store); })
        .catch(err => { console.error(err); alert("Credenciales incorrectas."); });
    });

    logoutBtn.addEventListener("click", async () => {
      if (!confirm("¬øEst√°s seguro de que quieres cerrar sesi√≥n?")) return;
      try {
        await signOut(auth);
        localStorage.removeItem("userStore");
        localStorage.removeItem("loggedInUser");
      } catch (error) {
        console.error("Error al cerrar sesi√≥n:", error);
        alert("‚ùå Error al cerrar sesi√≥n");
      }
    });

    // CARGA POR LOTES (optimizada)
    async function loadImagesFromStorageBatched() {
      try {
        const map = window.firebaseImageUrls = window.firebaseImageUrls || {};
        const baseRef = ref(storage, 'images/');
        const top = await listAll(baseRef);

        for (const itemRef of top.items) {
          map[itemRef.fullPath] = await getDownloadURL(itemRef);
        }

        const folders = top.prefixes || [];
        const chunkSize = 4;
        for (let i = 0; i < folders.length; i += chunkSize) {
          const batch = folders.slice(i, i + chunkSize);
          await Promise.all(batch.map(async folderRef => {
            const fr = await listAll(folderRef);
            for (const itemRef of fr.items) {
              map[itemRef.fullPath] = await getDownloadURL(itemRef);
            }
          }));
          await new Promise(r => setTimeout(r, 0));
        }

        if (typeof window.updateProductImages === 'function') {
          window.updateProductImages();
        }
      } catch (e) {
        console.error('Error en carga por lotes:', e);
      }
    }

    // ACTUALIZAR IM√ÅGENES (asigna data-full)
    window.updateProductImages = function() {
      const map = window.firebaseImageUrls || {};
      document.querySelectorAll('.product img[data-src]').forEach(img => {
        const storagePath = img.dataset.src.trim();
        const url = map[storagePath];
        if (url) {
          img.dataset.full = url;
          if (!img.classList.contains('lazy')) img.src = url;
        }
      });
    };

    // LAZY LOADING ON-DEMAND
    window.lazyLoadImages = function() {
      const imgs = Array.from(document.querySelectorAll('img.lazy'));
      if (!imgs.length) return;

      const map = window.firebaseImageUrls = window.firebaseImageUrls || {};

      async function ensureUrl(key) {
        if (map[key]) return map[key];
        try {
          const url = await getDownloadURL(ref(storage, key));
          map[key] = url;
          return url;
        } catch (e) {
          return null;
        }
      }

      async function loadOne(img) {
        const key = (img.dataset.src || '').trim();
        if (!key) return;
        const url = await ensureUrl(key);
        if (url) {
          img.dataset.full = url;
          img.src = url;
          img.classList.remove('lazy');
          if (observer) observer.unobserve(img);
        }
      }

      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(e => { if (e.isIntersecting) loadOne(e.target); });
        }, { rootMargin: '200px 0px', threshold: 0.01 });
        imgs.forEach(img => observer.observe(img));
      } else {
        imgs.forEach(loadOne);
      }
    };

    // FULLSCREEN MODAL
    window.initFullscreenModal = function() {
      const productList = document.getElementById('product-list');
      const modal = document.getElementById('fullscreen-modal');
      const modalContent = modal.querySelector('.fullscreen-modal-content');
      const closeBtn = modal.querySelector('.close-fullscreen-modal');

      function openModal(card) {
        const img = card.querySelector('img[data-full]');
        const src = img?.dataset.full || img?.src;
        if (!src) return;
        modalContent.innerHTML = '';
        const big = document.createElement('img');
        big.src = src;
        modalContent.appendChild(big);
        modal.classList.remove('hidden');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeModal() {
        modal.classList.remove('active');
        setTimeout(() => {
          modal.classList.add('hidden');
          modalContent.innerHTML = '';
          document.body.style.overflow = '';
        }, 400);
      }

      productList.addEventListener('click', e => {
        const card = e.target.closest('.product');
        if (card && !e.target.closest('button,input,a')) {
          e.preventDefault();
          openModal(card);
        }
      });
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && modal.classList.contains('active')) closeModal();
      });
    };

    // FIRESTORE: guardar pedido
    window.sendOrderToFirestore = async function(orderItems) {
      try {
        const docRef = await addDoc(collection(db, "orders"), {
          store: localStorage.getItem("userStore") || "Sin tienda",
          user: localStorage.getItem("loggedInUser") || "An√≥nimo",
          created: serverTimestamp(),
          items: orderItems
        });
        console.log("‚úÖ Pedido guardado con ID:", docRef.id);
      } catch (e) {
        console.error("‚ùå Error al guardar pedido:", e);
        alert("‚ö†Ô∏è El pedido no pudo guardarse en la nube.");
      }
    };

    window.auth = auth;
    window.firebaseApp = app;
    window.db = db;
    window.firebaseStorage = storage;
  </script>

  <script src="script.js?v=2025101201"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CONSULTAS - Coca-Cola</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div id="login-container">
    <form id="login-form">
      <h2>Iniciar Sesi√≥n</h2>
      <select id="store" name="store" required>
        <option value="" disabled selected>Selecciona tu supermercado</option>
      </select>
      <input type="text" id="username" name="username" placeholder="Usuario (email)" autocomplete="username" required>
      <input type="password" id="password" name="password" placeholder="Contrase√±a" autocomplete="current-password" required>
      <button type="submit">Entrar</button>
      <a href="admin.html" style="display: block; margin-top: 15px; text-align: center; color: var(--color-primary); font-size: 0.9rem; text-decoration: none; font-weight: 600;">‚öôÔ∏è Panel de Administraci√≥n</a>
    </form>
  </div>

  <div id="contenido" class="hidden">
    <header>
      <h1>CONSULTAS</h1>
      <button id="logout-btn" class="btn-logout" aria-label="Cerrar sesi√≥n">üö™ Cerrar Sesi√≥n</button>
    </header>

    <main>
      <div class="dropdown-container"><div id="filter-container"></div></div>
      <section id="product-list" aria-live="polite"></section>

      <div id="total-display" aria-live="polite">Total: ‚Ç¨0.00</div>

      <button id="cart-toggle" aria-label="Ver carrito">üõí</button>

      <div id="cart-modal" role="dialog" aria-modal="true" aria-labelledby="cart-modal-title">
        <div id="cart-modal-content">
          <h2 id="cart-modal-title">Tu Pedido</h2>
          <button id="close-modal" aria-label="Cerrar carrito">‚úñ</button>
          <div id="cart-items-modal">No hay productos a√±adidos.</div>
          <div id="modal-total">Total: ‚Ç¨0.00</div>
          <button id="submit-order">Enviar Pedido</button>
        </div>
      </div>
    </main>
  </div>

  <audio id="add-sound" src="beep.mp3" preload="auto"></audio>

  <div id="fullscreen-modal" class="fullscreen-modal-overlay hidden">
    <span class="close-fullscreen-modal">&times;</span>
    <div class="fullscreen-modal-content"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp }            from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth,
             signInWithEmailAndPassword,
             onAuthStateChanged,
             signOut }                  from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore,
             collection,
             addDoc,
             serverTimestamp }          from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getStorage,
             ref,
             getDownloadURL,
             listAll }              from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

    /* --- CONFIG FIREBASE ------------------------------------------------- */
    const firebaseConfig = {
      apiKey:            "AIzaSyA3SNRVPID2Gz85UhESHr_OEdxsL1PNodM",
      authDomain:        "cocacolaconsultas-20759.firebaseapp.com",
      projectId:         "cocacolaconsultas-20759",
      storageBucket:     "cocacolaconsultas-20759.firebasestorage.app",
      messagingSenderId: "274074684363",
      appId:             "1:274074684363:web:b988c76c7e74f9e1e3444e",
      measurementId:     "G-29GJZ22GMM"
    };
    
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const storage = getStorage(app);

    /* --- ELEMENTOS DOM --------------------------------------------------- */
    const loginContainer = document.getElementById("login-container");
    const contenidoDiv   = document.getElementById("contenido");
    const loginForm      = document.getElementById("login-form");
    const storeSelect    = document.getElementById("store");
    const headerH1       = document.querySelector("#contenido header h1");
    const logoutBtn      = document.getElementById("logout-btn");

    /* --- HELPER: mostrar contenido privado ------------------------------- */
    function mostrarContenido(storeName){
      loginContainer.style.display = "none";
      contenidoDiv.classList.remove("hidden");
      if (storeName && !headerH1.textContent.includes(storeName)){
        headerH1.textContent += ` - ${storeName}`;
      }
    }

    /* --- AUTH LISTENER --------------------------------------------------- */
    onAuthStateChanged(auth, user=>{
      if (user){
        const userStore = localStorage.getItem("userStore");
        mostrarContenido(userStore);
        localStorage.setItem("loggedInUser", user.email);
        // Cargar im√°genes desde Firebase Storage
        loadImagesFromStorage();
      }else{
        loginContainer.style.display = "flex";
        contenidoDiv.classList.add("hidden");
      }
    });

    /* --- CARGAR SELECT DE TIENDAS ---------------------------------------- */
    document.addEventListener("DOMContentLoaded",()=>{
      const stores = ["CAT21","CAT22","CAT23","CAT24","CAT25","EJE4",
                      "Alcampo Sant Quirze","Carrefour Sant Cugat","Carrefour Barbera"];
      stores.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = opt.textContent = s;
        storeSelect.appendChild(opt);
      });
    });

    /* --- LOGIN ----------------------------------------------------------- */
    loginForm.addEventListener("submit",e=>{
      e.preventDefault();
      const store    = storeSelect.value;
      const email    = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!store){ alert("Por favor selecciona un supermercado."); return; }

      signInWithEmailAndPassword(auth,email,password)
        .then(()=>{
          localStorage.setItem("userStore",store);
          mostrarContenido(store);
        })
        .catch(err=>{
          console.error(err);
          alert("Credenciales incorrectas. Verifica tu email y contrase√±a.");
        });
    });

    /* --- LOGOUT ---------------------------------------------------------- */
    logoutBtn.addEventListener("click", async () => {
      const confirmed = confirm("¬øEst√°s seguro de que quieres cerrar sesi√≥n?");
      if (confirmed) {
        try {
          await signOut(auth);
          localStorage.removeItem("userStore");
          localStorage.removeItem("loggedInUser");
          console.log("‚úÖ Sesi√≥n cerrada correctamente");
        } catch (error) {
          console.error("Error al cerrar sesi√≥n:", error);
          alert("‚ùå Error al cerrar sesi√≥n");
        }
      }
    });

    /* --- CARGAR IM√ÅGENES DESDE FIREBASE STORAGE (OPTIMIZADO) ------------- */
    async function loadImagesFromStorage() {
      try {
        console.log('üîÑ Cargando im√°genes desde Firebase Storage...');
        const imagesRef = ref(storage, 'images/');
        const result = await listAll(imagesRef);

        const imageUrls = {};
        const storageBucketName = 'cocacolaconsultas-20759.appspot.com'; // Usar el bucket de tu config

        // Funci√≥n para obtener la ruta completa del storage (ej: images/folder/file.jpg)
        const getFullPath = (itemRef) => {
          // El itemRef.fullPath ya contiene la ruta completa del storage (ej: images/folder/file.jpg)
          return itemRef.fullPath;
        };

        // Archivos en ra√≠z (compatibilidad, ej: images/file.jpg)
        for (const itemRef of result.items) {
          const url = await getDownloadURL(itemRef);
          imageUrls[getFullPath(itemRef)] = url;
        }

        // Subcarpetas (secciones, ej: images/fem_carrefour/file.jpg)
        for (const folderRef of result.prefixes) {
          const folderResult = await listAll(folderRef);
          for (const itemRef of folderResult.items) {
            const url = await getDownloadURL(itemRef);
            // USAR LA RUTA COMPLETA COMO CLAVE
            imageUrls[getFullPath(itemRef)] = url; 
          }
        }

        window.firebaseImageUrls = imageUrls;
        console.log('‚úÖ Im√°genes cargadas:', Object.keys(imageUrls).length);
        updateProductImages();

      } catch (error) {
        console.error('‚ùå Error al cargar im√°genes:', error);
        window.firebaseImageUrls = {};
      }
    }

    /* --- ACTUALIZAR IM√ÅGENES EN PRODUCTOS ----------------------------- */
    function updateProductImages() {
      if (!window.firebaseImageUrls) return;
      document.querySelectorAll('.product img[data-src]').forEach(img => {
        const fullStoragePath = img.dataset.src.trim(); // Espera algo como: images/fem_carrefour/fem_carrefour_0.jpg
        const url = window.firebaseImageUrls[fullStoragePath];
        
        if (url) {
          img.dataset.src = url;
          if (!img.classList.contains('lazy')) {
            // Carga inmediata para las que no son "lazy" (generalmente las primeras)
            img.src = url; 
          } else {
             // La l√≥gica de lazy loading debe encargarse de asignar img.src despu√©s
          }
        } else {
          // Ya no buscamos solo por nombre de archivo, sino por la ruta completa
          console.warn(`‚ö†Ô∏è Imagen no encontrada en Storage: ${fullStoragePath}`);
        }
      });
    }

    /* --- FUNCI√ìN GLOBAL: guardar pedido en Firestore -------------------- */
    window.sendOrderToFirestore = async function(orderItems){
      try{
        const docRef = await addDoc(collection(db,"orders"),{
          store   : localStorage.getItem("userStore")   || "Sin tienda",
          user    : localStorage.getItem("loggedInUser")|| "An√≥nimo",
          created : serverTimestamp(),
          items   : orderItems
        });
        console.log("‚úÖ Pedido guardado con ID:", docRef.id);
      }catch(e){
        console.error("‚ùå Error al guardar pedido:",e);
        alert("‚ö†Ô∏è El pedido no pudo guardarse en la nube.");
      }
    };

    /* --- Exponer global (debug) ---------------------------------------- */
    window.auth = auth;
    window.firebaseApp = app;
    window.db = db;
    window.firebaseStorage = storage;
    console.log('‚úÖ Firebase expuesto globalmente');
  </script>

  <script src="script.js?v=2025101001"></script>
</body>
</html>

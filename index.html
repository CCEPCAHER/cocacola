<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CONSULTAS - Coca-Cola</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div id="login-container">
    <form id="login-form">
      <h2>Iniciar Sesi√≥n</h2>
      <select id="store" name="store" required>
        <option value="" disabled selected>Selecciona tu supermercado</option>
      </select>
      <input type="text" id="username" name="username" placeholder="Usuario (email)" autocomplete="username" required>
      <input type="password" id="password" name="password" placeholder="Contrase√±a" autocomplete="current-password" required>
      <button type="submit">Entrar</button>
      <a href="admin.html" style="display: block; margin-top: 15px; text-align: center; color: var(--color-primary); font-size: 0.9rem; text-decoration: none; font-weight: 600;">‚öôÔ∏è Panel de Administraci√≥n</a>
    </form>
  </div>

  <div id="contenido" class="hidden">
    <header>
      <h1>CONSULTAS</h1>
      <button id="logout-btn" class="btn-logout" aria-label="Cerrar sesi√≥n">üö™ Cerrar Sesi√≥n</button>
    </header>
    <main>
      <div class="dropdown-container"><div id="filter-container"></div></div>
      <section id="product-list" aria-live="polite"></section>
    </main>
  </div>

  <div id="fullscreen-modal" class="fullscreen-modal-overlay hidden">
    <span class="close-fullscreen-modal">&times;</span>
    <div class="fullscreen-modal-content"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA3SNRVPID2Gz85UhESHr_OEdxsL1PNodM",
      authDomain: "cocacolaconsultas-20759.firebaseapp.com",
      projectId: "cocacolaconsultas-20759",
      storageBucket: "cocacolaconsultas-20759.firebasestorage.app",
      messagingSenderId: "274074684363",
      appId: "1:274074684363:web:b988c76c7e74f9e1e3444e",
      measurementId: "G-29GJZ22GMM"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loginContainer = document.getElementById("login-container");
    const contenidoDiv = document.getElementById("contenido");
    const loginForm = document.getElementById("login-form");
    const storeSelect = document.getElementById("store");
    const headerH1 = document.querySelector("#contenido header h1");
    const logoutBtn = document.getElementById("logout-btn");

    function mostrarContenido(storeName) {
      loginContainer.style.display = "none";
      contenidoDiv.classList.remove("hidden");
      if (storeName && !headerH1.textContent.includes(storeName)) {
        headerH1.textContent += ` - ${storeName}`;
      }
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        const userStore = localStorage.getItem("userStore");
        mostrarContenido(userStore);
        localStorage.setItem("loggedInUser", user.email);
        loadImagesFromStorageBatched();
      } else {
        loginContainer.style.display = "flex";
        contenidoDiv.classList.add("hidden");
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const stores = ["CAT21","CAT22","CAT23","CAT24","CAT25","EJE4",
                      "Alcampo Sant Quirze","Carrefour Sant Cugat","Carrefour Barbera"];
      stores.forEach(s => {
        const opt = document.createElement("option");
        opt.value = opt.textContent = s;
        storeSelect.appendChild(opt);
      });
    });

    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      const store = storeSelect.value;
      const email = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!store) { alert("Por favor selecciona un supermercado."); return; }
      signInWithEmailAndPassword(auth, email, password)
        .then(() => { localStorage.setItem("userStore", store); mostrarContenido(store); })
        .catch(err => { console.error(err); alert("Credenciales incorrectas."); });
    });

    logoutBtn.addEventListener("click", async () => {
      if (!confirm("¬øEst√°s seguro de que quieres cerrar sesi√≥n?")) return;
      try {
        await signOut(auth);
        localStorage.removeItem("userStore");
        localStorage.removeItem("loggedInUser");
      } catch (error) {
        console.error("Error al cerrar sesi√≥n:", error);
        alert("‚ùå Error al cerrar sesi√≥n");
      }
    });

    // CARGA POR LOTES (optimizada)
    async function loadImagesFromStorageBatched() {
      try {
        const map = window.firebaseImageUrls = window.firebaseImageUrls || {};
        const baseRef = ref(storage, 'images/');
        const top = await listAll(baseRef);

        for (const itemRef of top.items) {
          map[itemRef.fullPath] = await getDownloadURL(itemRef);
        }

        const folders = top.prefixes || [];
        const chunkSize = 4;
        for (let i = 0; i < folders.length; i += chunkSize) {
          const batch = folders.slice(i, i + chunkSize);
          await Promise.all(batch.map(async folderRef => {
            const fr = await listAll(folderRef);
            for (const itemRef of fr.items) {
              map[itemRef.fullPath] = await getDownloadURL(itemRef);
            }
          }));
          await new Promise(r => setTimeout(r, 0));
        }

        if (typeof window.updateProductImages === 'function') {
          window.updateProductImages();
        }
      } catch (e) {
        console.error('Error en carga por lotes:', e);
      }
    }

    // ACTUALIZAR IM√ÅGENES (asigna data-full)
    window.updateProductImages = function() {
      const map = window.firebaseImageUrls || {};
      document.querySelectorAll('.product img[data-src]').forEach(img => {
        const storagePath = img.dataset.src.trim();
        const url = map[storagePath];
        if (url) {
          img.dataset.full = url;
          if (!img.classList.contains('lazy')) img.src = url;
        }
      });
    };

    // LAZY LOADING ON-DEMAND
    window.lazyLoadImages = function() {
      const imgs = Array.from(document.querySelectorAll('img.lazy'));
      if (!imgs.length) return;

      const map = window.firebaseImageUrls = window.firebaseImageUrls || {};

      async function ensureUrl(key) {
        if (map[key]) return map[key];
        try {
          const url = await getDownloadURL(ref(storage, key));
          map[key] = url;
          return url;
        } catch (e) {
          return null;
        }
      }

      async function loadOne(img) {
        const key = (img.dataset.src || '').trim();
        if (!key) return;
        const url = await ensureUrl(key);
        if (url) {
          img.dataset.full = url;
          img.src = url;
          img.classList.remove('lazy');
          if (observer) observer.unobserve(img);
        }
      }

      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(e => { if (e.isIntersecting) loadOne(e.target); });
        }, { rootMargin: '200px 0px', threshold: 0.01 });
        imgs.forEach(img => observer.observe(img));
      } else {
        imgs.forEach(loadOne);
      }
    };

    // FULLSCREEN MODAL CON NAVEGACI√ìN SWIPE/FLECHAS
    window.initFullscreenModal = function() {
      const productList = document.getElementById('product-list');
      const modal = document.getElementById('fullscreen-modal');
      const modalContent = modal.querySelector('.fullscreen-modal-content');
      const closeBtn = modal.querySelector('.close-fullscreen-modal');

      let currentSection = [];
      let currentIndex = 0;

      function openModal(card) {
        const section = card.closest('.section');
        const allCards = Array.from(section.querySelectorAll('.product[data-section-name]'));
        currentSection = allCards.filter(c => c.querySelector('img[data-full]'));
        currentIndex = currentSection.indexOf(card);

        showImage(currentIndex);
        modal.classList.remove('hidden');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function showImage(index) {
        if (index < 0 || index >= currentSection.length) return;
        
        const card = currentSection[index];
        const img = card.querySelector('img[data-full]');
        const src = img?.dataset.full || img?.src;
        if (!src) return;

        const prevDisabled = index === 0 ? 'style="opacity:0.3;pointer-events:none;"' : '';
        const nextDisabled = index === currentSection.length - 1 ? 'style="opacity:0.3;pointer-events:none;"' : '';

        modalContent.innerHTML = `
          <button class="modal-nav modal-nav-prev" ${prevDisabled}>‚Äπ</button>
          <img src="${src}" alt="Imagen ${index + 1}" title="Clic para pantalla completa">
          <button class="modal-nav modal-nav-next" ${nextDisabled}>‚Ä∫</button>
          <div class="modal-counter">${index + 1} / ${currentSection.length}</div>
        `;

        modalContent.querySelector('.modal-nav-prev')?.addEventListener('click', () => navigate(-1));
        modalContent.querySelector('.modal-nav-next')?.addEventListener('click', () => navigate(1));

        // Pantalla completa al hacer clic en imagen
        const bigImg = modalContent.querySelector('img');
        if (bigImg) {
          bigImg.addEventListener('click', toggleRealFullscreen);
        }
      }

      function navigate(direction) {
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < currentSection.length) {
          currentIndex = newIndex;
          showImage(currentIndex);
        }
      }

      function closeModal() {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        }
        modal.classList.remove('active');
        setTimeout(() => {
          modal.classList.add('hidden');
          modalContent.innerHTML = '';
          document.body.style.overflow = '';
        }, 400);
      }

      async function toggleRealFullscreen(e) {
        const img = e.target;
        if (!img) return;

        try {
          if (!document.fullscreenElement) {
            if (img.requestFullscreen) {
              await img.requestFullscreen();
            } else if (img.webkitRequestFullscreen) {
              await img.webkitRequestFullscreen();
            } else if (img.msRequestFullscreen) {
              await img.msRequestFullscreen();
            }
            img.classList.add('in-fullscreen');
          } else {
            if (document.exitFullscreen) {
              await document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
              await document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
              await document.msExitFullscreen();
            }
            img.classList.remove('in-fullscreen');
          }
        } catch (err) {
          console.error('Error al cambiar pantalla completa:', err);
        }
      }

      document.addEventListener('fullscreenchange', () => {
        const img = modalContent.querySelector('img');
        if (img && !document.fullscreenElement) {
          img.classList.remove('in-fullscreen');
        }
      });

      // Touch/Swipe support
      let touchStartX = 0;
      let touchEndX = 0;

      modalContent.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      modalContent.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const swipeThreshold = 50;
        if (touchStartX - touchEndX > swipeThreshold) {
          navigate(1);
        } else if (touchEndX - touchStartX > swipeThreshold) {
          navigate(-1);
        }
      }

      // Teclado
      document.addEventListener('keydown', e => {
        if (!modal.classList.contains('active')) return;
        if (e.key === 'ArrowLeft') navigate(-1);
        if (e.key === 'ArrowRight') navigate(1);
        if (e.key === 'Escape') closeModal();
      });

      productList.addEventListener('click', e => {
        const card = e.target.closest('.product');
        if (card && card.querySelector('img[data-full]') && !e.target.closest('button,input,a')) {
          e.preventDefault();
          openModal(card);
        }
      });

      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', e => {
        if (e.target === modal) closeModal();
      });
    };

    window.auth = auth;
    window.firebaseApp = app;
    window.db = db;
    window.firebaseStorage = storage;
  </script>

  <script src="script.js?v=2025101301"></script>
</body>
</html>
